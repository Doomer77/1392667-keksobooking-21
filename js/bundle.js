(()=>{"use strict";(()=>{const e="https://21.javascript.pages.academy/keksobooking/data",t="https://21.javascript.pages.academy/keksobooking",o="Произошла неизвестная ошибка. Пожалуйста, обновите страницу.",n="Произошла ошибка соединения. Пожалуйста, обновите страницу",a="Сервер долго не отвечает. Пожалуйста, обновите страницу.",i=(e,t,i,r)=>{let d=new XMLHttpRequest;return d.responseType="json",d.addEventListener("load",(()=>{200===d.status?i(d.response):r(o)})),d.addEventListener("error",(()=>{r(n)})),d.addEventListener("timeout",(()=>{r(a)})),d.open(e,t),d};window.backend={load:(t,o)=>{i("GET",e,t,o).send()},upload:(e,o,n)=>{i("POST",t,e,o).send(n)}}})(),window.util={KEY_NAME:{ENTER:"Enter",ESC:"Escape"},DEBOUNCE_INTERVAL:500,monipulateElementDOM:function(e){return document.querySelector(e)},getRandomNumber:function(e,t){return Math.floor(Math.random()*(e-t+1))+t},getShuffleArray:function(e){let t=e.slice(0);for(let e=0;e<t.length;e++){let o=Math.floor(Math.random()*(e+1)),n=t[e];t[e]=t[o],t[o]=n}return t},getRandomLengthArr:function(e){let t=e.slice(0),o=window.util.getRandomNumber(0,t.length+1);return t.slice(0,o)},onEscDown:function(e,t){null!==t&&e.key===this.KEY_NAME.ESC&&t.remove()},renderErrorMessage:function(e){let t=document.createElement("div");t.classList.add("error-message"),t.textContent=e,document.body.insertAdjacentElement("afterbegin",t)},debounce:function(e){let t=null;return function(...o){t&&window.clearTimeout(t),t=window.setTimeout((function(){e(...o)}),window.DEBOUNCE_INTERVAL)}}},window.data={PINS_LIMIT:5,TYPES_MAP:{PALACE:"Дворец",FLAT:"Квартира",HOUSE:"Дом",BUNGALO:"Бунгало"},PRICE_RANGE:{LOW:{MIN:0,MAX:1e4},MIDDLE:{MIN:1e4,MAX:5e4},HIGH:{MIN:5e4,MAX:1/0}},DRAG_LIMIT:{X:{MIN:-30,MAX:1230},Y:{MIN:130,MAX:680}},PIN_SICE:{WIDTH:65,HEIGHT:65},DEFAULT_MAIN_PIN_X:601,DEFAULT_MAIN_PIN_Y:404,TAIL_HEIGHT:16,FILE_TYPES:["gif","jpg","jpeg","png"],DEFAULT_AVATAR:"img/muffin-grey.svg",IMAGE_PARAMS:{WIDTH:"70px",HEIGHT:"70px",BORDER_RADIUS:"5px"}},(()=>{const e=window.util.monipulateElementDOM(".ad-form-header__preview img"),t=window.util.monipulateElementDOM(".ad-form__upload"),o=window.util.monipulateElementDOM("#avatar"),n=window.util.monipulateElementDOM("#images"),a=e=>window.data.FILE_TYPES.some((t=>e.name.toLowerCase().endsWith(t))),i=t=>{e.src=t},r=e=>{let o=document.createElement("div"),n=document.createElement("img");o.classList.add("ad-form__photo"),o.classList.add("ad-form__photo--added"),n.src=e,n.style.width=window.data.IMAGE_PARAMS.WIDTH,n.style.height=window.data.IMAGE_PARAMS.HEIGHT,n.style.borderRadius=window.data.IMAGE_PARAMS.BORDER_RADIUS,o.appendChild(n),t.appendChild(o),(()=>{let e=window.util.monipulateElementDOM(".ad-form__photo--empty");e&&e.remove()})()},d=(e,t)=>{let o=Array.from(e.files).filter(a);o&&o.forEach((e=>{let o=new FileReader;o.addEventListener("load",(e=>{t(e.target.result)})),o.readAsDataURL(e)}))},l=e=>{d(e.target,i)},u=e=>{d(e.target,r)};window.loadImage={activate:()=>{o.addEventListener("change",l),n.addEventListener("change",u)},deactivate:()=>{o.removeEventListener("change",l),n.removeEventListener("change",u)},remove:()=>{e.src=window.data.DEFAULT_AVATAR;let o=document.querySelectorAll(".ad-form__photo--added");o&&o.forEach((function(e){e.remove()})),(()=>{if(!window.util.monipulateElementDOM(".ad-form__photo--empty")){let e=document.createElement("div");e.classList.add("ad-form__photo"),e.classList.add("ad-form__photo--empty"),t.appendChild(e)}})()}}})(),(()=>{const e=window.util.monipulateElementDOM(".map"),t=window.util.monipulateElementDOM(".map__pins"),o=window.util.monipulateElementDOM("#pin"),n=window.util.monipulateElementDOM("#card"),a=o.content.querySelector(".map__pin"),i=n.content.querySelector(".map__card"),r=n.content.querySelector(".popup__photo"),d=window.util.monipulateElementDOM(".map__filters-container"),l=window.util.monipulateElementDOM(".map__pin--main"),u=e=>{if("object"==typeof e)switch(e.button){case 0:window.map.activate(),window.form.activate(),l.removeEventListener("mousedown",u)}},c=()=>{const e=document.querySelectorAll(".map__pin:not(.map__pin--main)");for(let t=0;t<e.length;t++)e[t].remove()},s=()=>{let e=document.querySelector(".map__card");e&&e.remove()},p=()=>{e.classList.add("map--faded"),c(),s(),l.style.top=window.data.DEFAULT_MAIN_PIN_Y-window.data.PIN_SICE.HEIGHT/2+"px",l.style.left=window.data.DEFAULT_MAIN_PIN_X-window.data.PIN_SICE.WIDTH/2+"px",l.addEventListener("mousedown",u)};p();const m=e=>{window.filter.activate(e)},w=e=>{window.util.renderErrorMessage(e)},f=t=>{let o=a.cloneNode(!0),n=o.querySelector("img");return n.src=t.author.avatar,n.alt=t.offer.title,o.style.left=t.location.x+"px",o.style.top=t.location.y+"px",o.addEventListener("click",(()=>{let o=e.querySelector(".map__card");o&&o.remove(),_(t),document.addEventListener("keydown",(t=>{window.util.onEscDown(t,e.querySelector(".map__card"))}))})),o};window.renderPinsMarkup=e=>{let o=document.createDocumentFragment();for(let t=0;t<e.length;t++)o.appendChild(f(e[t]));t.appendChild(o)};const _=e=>{let t=i.cloneNode(!0);return t.querySelector(".popup__title").textContent=e.offer.title,t.querySelector(".popup__text--address").textContent=e.offer.address,t.querySelector(".popup__text--price").textContent=e.offer.price+"₽/ночь","palace"===e.offer.type?t.querySelector(".popup__type").textContent=window.data.TYPES_MAP.PALACE:"flat"===e.offer.type?t.querySelector(".popup__type").textContent=window.data.TYPES_MAP.FLAT:"house"===e.offer.type?t.querySelector(".popup__type").textContent=window.data.TYPES_MAP.HOUSE:t.querySelector(".popup__type").textContent=window.data.TYPES_MAP.BUNGALO,t.querySelector(".popup__text--capacity").textContent=`${e.offer.rooms} комнаты для ${e.offer.guests} гостей`,t.querySelector(".popup__text--time").textContent=`Заезд после ${e.offer.checkin}, выезд до ${e.offer.checkout}`,t.querySelector(".popup__features").innerHTML="",t.querySelector(".popup__features").appendChild((e=>{let t=document.createDocumentFragment();for(let o=0;o<e.length;o++){let n=document.createElement("li");n.className="popup__feature popup__feature--"+e[o],t.appendChild(n)}return t})(e.offer.features)),t.querySelector(".popup__description").textContent=e.offer.description,t.querySelector(".popup__photos").removeChild(t.querySelector(".popup__photo")),t.querySelector(".popup__photos").appendChild((e=>{let t=document.createDocumentFragment();for(let o=0;o<e.length;o++){let n=r.cloneNode(!0);n.src=e[o],t.appendChild(n)}return t})(e.offer.photos)),t.querySelector(".map__card .popup__avatar").src=e.author.avatar,d.insertAdjacentElement("beforebegin",t),t.querySelector(".popup__close").addEventListener("click",(()=>{t.remove(),document.removeEventListener("click",window.util.onEscDown)})),t};window.map={getMainPinDefaultCoords:()=>({x:window.data.DEFAULT_MAIN_PIN_X,y:window.data.DEFAULT_MAIN_PIN_Y}),removePins:c,removeMapCard:s,activate:()=>{window.backend.load(m,w),e.classList.remove("map--faded")},deactivate:p,renderPinsMarkup:window.renderPinsMarkup}})(),(()=>{const e=window.util.monipulateElementDOM(".map__pin--main");e.addEventListener("mousedown",(t=>{t.preventDefault();let o={x:t.clientX,y:t.clientY};const n=t=>{t.preventDefault();let n=o.x-t.clientX,a=o.y-t.clientY;o={x:t.clientX,y:t.clientY};let i=e.offsetLeft-n,r=e.offsetTop-a;const d=window.data.DRAG_LIMIT.Y.MIN-e.offsetHeight,l=window.data.DRAG_LIMIT.Y.MAX-e.offsetHeight,u=window.data.DRAG_LIMIT.X.MIN,c=window.data.DRAG_LIMIT.X.MAX-e.offsetWidth;i>=u&&i<=c&&(e.style.left=i+"px"),r>=d&&r<=l&&(e.style.top=r+"px");let s={x:i+Math.ceil(window.data.PIN_SICE.WIDTH/2),y:r+window.data.PIN_SICE.HEIGHT+window.data.TAIL_HEIGHT};window.form.setAddress(s)},a=e=>{e.preventDefault(),document.removeEventListener("mousemove",n),document.removeEventListener("mouseup",a)};document.addEventListener("mousemove",n),document.addEventListener("mouseup",a)}))})(),(()=>{const e=window.util.monipulateElementDOM(".map__pin--main"),t=window.util.monipulateElementDOM(".ad-form"),o=t.querySelectorAll(".ad-form__element"),n=t.querySelector(".ad-form-header"),a=t.querySelector("#address"),i=window.util.monipulateElementDOM("#type"),r=window.util.monipulateElementDOM("#price"),d=window.util.monipulateElementDOM("#timein"),l=window.util.monipulateElementDOM("#timeout"),u=window.util.monipulateElementDOM("#room_number"),c=window.util.monipulateElementDOM("#capacity"),s=window.util.monipulateElementDOM(".ad-form__submit"),p=window.util.monipulateElementDOM("main"),m=window.util.monipulateElementDOM("#success").content.querySelector(".success"),w=window.util.monipulateElementDOM("#error"),f=w.content.querySelector(".error"),_=w.content.querySelector(".error__button"),E=window.util.monipulateElementDOM(".ad-form__reset"),v=()=>{a.value=`${e.offsetTop-e.offsetHeight/2}, ${e.offsetLeft-e.offsetWidth/2}`};v(),window.fillAddress=()=>{let t=e.offsetLeft+Math.floor(e.offsetWidth/2),o=e.offsetTop+e.offsetHeight;a.value=`${t} ${o}`},e.addEventListener("keydown",(e=>{e.key===window.util.KEY_NAME.ENTER&&(window.map.activate(),window.form.activate(),window.fillAddress())}));const h=()=>{t.reset();for(let e=0;e<o.length;e++)o[e].disabled=!0;n.disabled=!0,window.map.getMainPinDefaultCoords(),v(),t.classList.add("ad-form--disabled"),window.loadImage.deactivate(),window.loadImage.remove()};h(),i.addEventListener("change",(e=>{switch(e.target.value){case"bungalow":r.min=0,r.placeholder="0";break;case"flat":r.min=1e3,r.placeholder="1000";break;case"house":r.min=5e3,r.placeholder="5000";break;case"palace":r.min=1e4,r.placeholder="10000"}})),d.addEventListener("change",(e=>{l.value=e.target.value})),l.addEventListener("change",(e=>{d.value=e.target.value}));const y={1:[1],2:[1,2],3:[1,2,3],100:[0]};u.addEventListener("change",(()=>{(e=>{let t=c.querySelectorAll("option");for(let e=0;e<t.length;e++)t[e].disabled=!0;for(let t=0;t<y[e].length;t++)c.querySelector(`option[value="${y[e][t]}"]`).disabled=!1,c.value=y[e][t]})(u.value)})),u.addEventListener("change",(e=>{e.target.setCustomValidity("")})),c.addEventListener("change",(e=>{e.target.setCustomValidity("")})),s.addEventListener("click",(()=>{M()}));const M=()=>{-1===y[u.value].indexOf(+c.value)?c.setCustomValidity("Количество гостей не влезут в выбранную комнату"):c.setCustomValidity("")},A=()=>{p.appendChild(f),window.addEventListener("keydown",(e=>{window.util.onEscDown(e,f)&&f.remove()})),document.addEventListener("click",(()=>{f.remove()})),_.addEventListener("click",(()=>{f.remove()}))},L=()=>{p.appendChild(m),window.addEventListener("keydown",(e=>{window.util.onEscDown(e,m)&&m.remove()})),document.addEventListener("click",(()=>{m.remove()})),window.map.deactivate(),window.form.deactivate(),window.filter.deactivate()};t.addEventListener("submit",(e=>{e.preventDefault();let o=new FormData(t);window.backend.upload(L,A,o)})),E.addEventListener("click",(function(){window.map.deactivate(),window.form.deactivate(),window.filter.deactivate(),window.loadImage.remove()})),window.form={setAddress:window.fillAddress,activate:()=>{t.classList.remove("ad-form--disabled");for(let e=0;e<o.length;e++)o[e].disabled=!1;n.disabled=!1,window.fillAddress(),window.loadImage.activate()},deactivate:h}})(),(()=>{const e=window.util.monipulateElementDOM(".map__filters"),t=e.querySelectorAll("select, input"),o=e.querySelector("#housing-type"),n=e.querySelector("#housing-price"),a=e.querySelector("#housing-rooms"),i=e.querySelector("#housing-guests"),r=e.querySelector("#housing-features");let d=[],l=[];const u=(e,t,o)=>"any"===e.value||e.value===t[o].toString(),c=e=>u(o,e.offer,"type"),s=e=>{let t=window.data.PRICE_RANGE[n.value.toUpperCase()];return!t||e.offer.price>=t.MIN&&e.offer.price<=t.MAX},p=e=>u(a,e.offer,"rooms"),m=e=>u(i,e.offer,"guests"),w=function(e){let t=r.querySelectorAll("input:checked");return Array.from(t).every((t=>e.offer.features.includes(t.value)))},f=window.util.debounce((()=>{l=d.slice(0),l=l.filter(c).filter(s).filter(p).filter(m).filter(w),window.map.removePins(),window.map.removeMapCard(),window.map.renderPinsMarkup(l.slice(0,window.data.PINS_LIMIT))}));window.filter={activate:o=>(d=o.slice(0),t.forEach((e=>{e.disabled=!1})),f(),e.addEventListener("change",f),o.slice(0,window.dataPINS_LIMIT)),deactivate:()=>{t.forEach((e=>{e.disabled=!0})),t.forEach((e=>{e.value="any"})),r.querySelectorAll("input").forEach((e=>{e.checked=!1})),e.removeEventListener("change",f)}}})()})();