(()=>{"use strict";(()=>{const e="https://21.javascript.pages.academy/keksobooking/data",t="https://21.javascript.pages.academy/keksobooking",o="Произошла неизвестная ошибка. Пожалуйста, обновите страницу.",n="Произошла ошибка соединения. Пожалуйста, обновите страницу",r="Сервер долго не отвечает. Пожалуйста, обновите страницу.",a=(e,t,a,i)=>{let d=new XMLHttpRequest;return d.responseType="json",d.addEventListener("load",(()=>{200===d.status?a(d.response):i(o)})),d.addEventListener("error",(()=>{i(n)})),d.addEventListener("timeout",(()=>{i(r)})),d.open(e,t),d};window.backend={load:(t,o)=>a("GET",e,t,o).send(),upload:(e,o,n)=>a("POST",t,e,o).send(n)}})(),window.util={mapPinMain:document.querySelector(".map__pin--main"),KEY_NAME:{ENTER:"Enter"},PIN_SICE:{WIDTH:65,HEIGHT:84},onEscDown:(e,t)=>{null!==t&&"Escape"===e.key&&t.remove()},renderErrorMessage:e=>{let t=document.createElement("div");t.classList.add("error-message"),t.textContent=e,document.body.insertAdjacentElement("afterbegin",t)},debounce:e=>{let t=null;return(...o)=>{t&&window.clearTimeout(t),t=window.setTimeout((()=>{e(...o)}),500)}}},(()=>{const e=document.querySelector(".ad-form-header__preview img"),t=document.querySelector(".ad-form__upload"),o=document.querySelector("#avatar"),n=document.querySelector("#images"),r=["gif","jpg","jpeg","png"],a={WIDTH:"70px",HEIGHT:"70px",BORDER_RADIUS:"5px"},i=e=>r.some((t=>e.name.toLowerCase().endsWith(t))),d=t=>{e.src=t},l=e=>{let{WIDTH:o,HEIGHT:n,BORDER_RADIUS:r}=a,i=document.createElement("div"),d=document.createElement("img");i.classList.add("ad-form__photo"),i.classList.add("ad-form__photo--added"),d.src=e,d.style.width=o,d.style.height=n,d.style.borderRadius=r,i.appendChild(d),t.appendChild(i),(()=>{let e=document.querySelector(".ad-form__photo--empty");e&&e.remove()})()},c=(e,t)=>{let o=Array.from(e.files).filter(i);o&&o.forEach((e=>{let o=new FileReader;o.addEventListener("load",(e=>{t(e.target.result)})),o.readAsDataURL(e)}))},u=e=>c(e.target,d),s=e=>c(e.target,l);window.loadImage={activate:()=>{o.addEventListener("change",u),n.addEventListener("change",s)},deactivate:()=>{o.removeEventListener("change",u),n.removeEventListener("change",s)},removeImages:()=>{e.src="img/muffin-grey.svg";let o=document.querySelectorAll(".ad-form__photo--added");o&&o.forEach((e=>{e.remove()})),(()=>{if(!document.querySelector(".ad-form__photo--empty")){let e=document.createElement("div");e.classList.add("ad-form__photo"),e.classList.add("ad-form__photo--empty"),t.appendChild(e)}})()}}})(),(()=>{const e=document.querySelector(".map"),t=document.querySelector(".map__pins"),o=document.querySelector("#pin"),n=document.querySelector("#card"),r=o.content.querySelector(".map__pin"),a=n.content.querySelector(".map__card"),i=n.content.querySelector(".popup__photo"),d=document.querySelector(".map__filters-container"),l={PALACE:"Дворец",FLAT:"Квартира",HOUSE:"Дом",BUNGALO:"Бунгало"},c={WIDTH:50,HEIGHT:70},u=e=>{if("object"==typeof e)switch(e.button){case 0:window.map.activateMap(),window.form.activateForm(),window.util.mapPinMain.removeEventListener("mousedown",u)}},s=()=>{const e=document.querySelectorAll(".map__pin:not(.map__pin--main)");for(let t=0;t<e.length;t++)e[t].remove()},p=()=>{let e=document.querySelector(".map__card");e&&e.remove()},m=()=>{e.classList.add("map--faded"),s(),p(),window.util.mapPinMain.style.top=404-window.util.PIN_SICE.HEIGHT/2+"px",window.util.mapPinMain.style.left=601-window.util.PIN_SICE.WIDTH/2+"px",window.util.mapPinMain.addEventListener("mousedown",u)};m();const f=e=>window.filter.activateFiltration(e),w=e=>window.util.renderErrorMessage(e),v=t=>{let o=r.cloneNode(!0),n=o.querySelector("img");n.src=t.author.avatar,n.alt=t.offer.title;let{WIDTH:a,HEIGHT:i}=c;return o.style.left=t.location.x-a/2+"px",o.style.top=t.location.y-i+"px",o.addEventListener("click",(()=>{let o=e.querySelector(".map__card");o&&o.remove(),y(t),document.addEventListener("keydown",(t=>{window.util.onEscDown(t,e.querySelector(".map__card"))}))})),o},y=e=>{let{PALACE:t,FLAT:o,HOUSE:n,BUNGALO:r}=l,c=a.cloneNode(!0);return c.querySelector(".popup__title").textContent=e.offer.title,c.querySelector(".popup__text--address").textContent=e.offer.address,c.querySelector(".popup__text--price").textContent=e.offer.price+"₽/ночь","palace"===e.offer.type?c.querySelector(".popup__type").textContent=t:"flat"===e.offer.type?c.querySelector(".popup__type").textContent=o:"house"===e.offer.type?c.querySelector(".popup__type").textContent=n:c.querySelector(".popup__type").textContent=r,c.querySelector(".popup__text--capacity").textContent=`${e.offer.rooms} комнаты для ${e.offer.guests} гостей`,c.querySelector(".popup__text--time").textContent=`Заезд после ${e.offer.checkin}, выезд до ${e.offer.checkout}`,c.querySelector(".popup__features").innerHTML="",c.querySelector(".popup__features").appendChild((e=>{let t=document.createDocumentFragment();for(let o=0;o<e.length;o++){let n=document.createElement("li");n.className="popup__feature popup__feature--"+e[o],t.appendChild(n)}return t})(e.offer.features)),c.querySelector(".popup__description").textContent=e.offer.description,c.querySelector(".popup__photos").removeChild(c.querySelector(".popup__photo")),c.querySelector(".popup__photos").appendChild((e=>{let t=document.createDocumentFragment();for(let o=0;o<e.length;o++){let n=i.cloneNode(!0);n.src=e[o],t.appendChild(n)}return t})(e.offer.photos)),c.querySelector(".map__card .popup__avatar").src=e.author.avatar,d.insertAdjacentElement("beforebegin",c),c.querySelector(".popup__close").addEventListener("click",(()=>{c.remove(),document.removeEventListener("click",window.util.onEscDown)})),c};window.map={getMainPinDefaultCoords:()=>({x:601,y:404}),removePins:s,removeMapCard:p,activateMap:()=>{window.backend.load(f,w),e.classList.remove("map--faded")},deactivateMap:m,renderPinsMarkup:e=>{let o=document.createDocumentFragment();for(let t=0;t<e.length;t++)o.appendChild(v(e[t]));t.appendChild(o)}}})(),(()=>{let{X:{MIN_X:e,MAX_X:t},Y:{MIN_Y:o,MAX_Y:n}}={X:{MIN_X:-32,MAX_X:1233},Y:{MIN_Y:130,MAX_Y:630}};window.util.mapPinMain.addEventListener("mousedown",(r=>{r.preventDefault();let a={x:r.clientX,y:r.clientY};const i=r=>{r.preventDefault();let i=a.x-r.clientX,d=a.y-r.clientY;a={x:r.clientX,y:r.clientY};let l=window.util.mapPinMain.offsetLeft-i,c=window.util.mapPinMain.offsetTop-d;const u=o-window.util.mapPinMain.offsetHeight,s=n-window.util.mapPinMain.offsetHeight,p=e,m=t-window.util.mapPinMain.offsetWidth;l>=p&&l<=m&&(window.util.mapPinMain.style.left=l+"px"),c>=u&&c<=s&&(window.util.mapPinMain.style.top=c+"px");let f={x:l+Math.ceil(window.util.PIN_SICE.HEIGHT/2),y:c+window.util.PIN_SICE.HEIGHT+16};window.address.fillAddress(f)},d=e=>{e.preventDefault(),document.removeEventListener("mousemove",i),document.removeEventListener("mouseup",d)};document.addEventListener("mousemove",i),document.addEventListener("mouseup",d)}))})(),(()=>{const e=document.querySelector(".ad-form"),t=e.querySelectorAll(".ad-form__element"),o=e.querySelector(".ad-form-header"),n=e.querySelector("#address"),r=document.querySelector("#type"),a=document.querySelector("#price"),i=document.querySelector("#timein"),d=document.querySelector("#timeout"),l=document.querySelector("#room_number"),c=document.querySelector("#capacity"),u=document.querySelector(".ad-form__submit"),s=document.querySelector("main"),p=document.querySelector("#success").content.querySelector(".success"),m=document.querySelector("#error"),f=m.content.querySelector(".error"),w=m.content.querySelector(".error__button"),v=document.querySelector(".ad-form__reset"),y={1:[1],2:[1,2],3:[1,2,3],100:[0]},_=()=>{n.value=`${Math.floor(window.util.mapPinMain.offsetLeft)-Math.floor(window.util.mapPinMain.offsetWidth/2)}, ${Math.floor(window.util.mapPinMain.offsetTop)-Math.floor(window.util.mapPinMain.offsetHeight/2)}`};_();const E=()=>{let e=window.util.mapPinMain.offsetLeft+Math.floor(window.util.PIN_SICE.WIDTH/2),t=window.util.mapPinMain.offsetTop+window.util.PIN_SICE.HEIGHT;n.value=`${e} ${t}`};window.util.mapPinMain.addEventListener("keydown",(e=>{e.key===window.util.KEY_NAME.ENTER&&(window.map.activateMap(),window.form.activateForm(),E())}));const h=()=>{e.reset();for(let e=0;e<t.length;e++)t[e].disabled=!0;o.disabled=!0,e.disabled=!0,window.map.getMainPinDefaultCoords(),_(),e.classList.add("ad-form--disabled"),window.loadImage.deactivate(),window.loadImage.removeImages()};h(),r.addEventListener("change",(e=>{switch(e.target.value){case"bungalow":a.min=0,a.placeholder="0";break;case"flat":a.min=1e3,a.placeholder="1000";break;case"house":a.min=5e3,a.placeholder="5000";break;case"palace":a.min=1e4,a.placeholder="10000"}})),i.addEventListener("change",(e=>{d.value=e.target.value})),d.addEventListener("change",(e=>{i.value=e.target.value})),l.addEventListener("change",(()=>{(e=>{let t=c.querySelectorAll("option");for(let e=0;e<t.length;e++)t[e].disabled=!0;for(let t=0;t<y[e].length;t++)c.querySelector(`option[value="${y[e][t]}"]`).disabled=!1,c.value=y[e][t]})(l.value)})),l.addEventListener("change",(e=>{e.target.setCustomValidity("")})),c.addEventListener("change",(e=>{e.target.setCustomValidity("")})),u.addEventListener("click",(()=>{S()}));const S=()=>{-1===y[l.value].indexOf(+c.value)?c.setCustomValidity("Количество гостей не влезут в выбранную комнату"):c.setCustomValidity("")},g=()=>{s.appendChild(f),window.addEventListener("keydown",(e=>{window.util.onEscDown(e,f)&&f.remove()})),document.addEventListener("click",(()=>{f.remove()})),w.addEventListener("click",(()=>{f.remove()}))},q=()=>{s.appendChild(p),window.addEventListener("keydown",(e=>{window.util.onEscDown(e,p)&&p.remove()})),document.addEventListener("click",(()=>{p.remove()})),window.map.deactivateMap(),window.form.deactivationForm(),window.filter.deactivateFiltration()};e.addEventListener("submit",(t=>{t.preventDefault();let o=new FormData(e);window.backend.upload(q,g,o)})),v.addEventListener("click",(()=>{window.map.deactivate(),window.form.deactivationForm(),window.filter.deactivateFiltration(),window.loadImage.removeImages()})),window.form={activateForm:()=>{e.classList.remove("ad-form--disabled");for(let e=0;e<t.length;e++)t[e].disabled=!1;o.disabled=!1,e.disabled=!1,E(),window.loadImage.activate()},deactivationForm:h},window.address={fillAddress:E}})(),(()=>{const e=document.querySelector(".map__filters"),t=e.querySelectorAll("select, input"),o=e.querySelector("#housing-type"),n=e.querySelector("#housing-price"),r=e.querySelector("#housing-rooms"),a=e.querySelector("#housing-guests"),i=e.querySelector("#housing-features");let d=[],l=[];const c={LOW:{MIN:0,MAX:1e4},MIDDLE:{MIN:1e4,MAX:5e4},HIGH:{MIN:5e4,MAX:1/0}},u=(e,t,o)=>"any"===e.value||e.value===t[o].toString(),s=e=>u(o,e.offer,"type"),p=e=>{let t=c[n.value.toUpperCase()];return!t||e.offer.price>=t.MIN&&e.offer.price<=t.MAX},m=e=>u(r,e.offer,"rooms"),f=e=>u(a,e.offer,"guests"),w=e=>{let t=i.querySelectorAll("input:checked");return Array.from(t).every((t=>e.offer.features.includes(t.value)))},v=window.util.debounce((()=>{l=d.slice(0),l=l.filter(s).filter(p).filter(m).filter(f).filter(w),window.map.removePins(),window.map.removeMapCard(),window.map.renderPinsMarkup(l.slice(0,5))}));window.filter={activateFiltration:o=>(d=o.slice(0),e.disabled=!1,t.forEach((e=>{e.disabled=!1})),v(),e.addEventListener("change",v),o.slice(0,5)),deactivateFiltration:()=>(e.disabled=!0,t.forEach((e=>{e.disabled=!0})),t.forEach((e=>{e.value="any"})),i.querySelectorAll("input").forEach((e=>{e.checked=!1})),void e.removeEventListener("change",v))}})()})();