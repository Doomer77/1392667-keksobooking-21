(()=>{"use strict";(()=>{const e="https://21.javascript.pages.academy/keksobooking/data",t="https://21.javascript.pages.academy/keksobooking",o="Произошла неизвестная ошибка. Пожалуйста, обновите страницу.",n="Произошла ошибка соединения. Пожалуйста, обновите страницу",r="Сервер долго не отвечает. Пожалуйста, обновите страницу.",a=(e,t,a,i)=>{let d=new XMLHttpRequest;return d.responseType="json",d.addEventListener("load",(()=>{200===d.status?a(d.response):i(o)})),d.addEventListener("error",(()=>{i(n)})),d.addEventListener("timeout",(()=>{i(r)})),d.open(e,t),d};window.backend={load:(t,o)=>{a("GET",e,t,o).send()},upload:(e,o,n)=>{a("POST",t,e,o).send(n)}}})(),window.util={KEY_NAME:{ENTER:"Enter",ESC:"Escape"},DEBOUNCE_INTERVAL:500,monipulateElementDOM:function(e){return document.querySelector(e)},getRandomNumber:function(e,t){return Math.floor(Math.random()*(e-t+1))+t},getShuffleArray:function(e){let t=e.slice(0);for(let e=0;e<t.length;e++){let o=Math.floor(Math.random()*(e+1)),n=t[e];t[e]=t[o],t[o]=n}return t},getRandomLengthArr:function(e){let t=e.slice(0),o=window.util.getRandomNumber(0,t.length+1);return t.slice(0,o)},onEscDown:function(e,t){null!==t&&e.key===this.KEY_NAME.ESC&&t.remove()},renderErrorMessage:function(e){let t=document.createElement("div");t.classList.add("error-message"),t.textContent=e,document.body.insertAdjacentElement("afterbegin",t)},debounce:function(e){let t=null;return function(...o){t&&window.clearTimeout(t),t=window.setTimeout((function(){e(...o)}),window.DEBOUNCE_INTERVAL)}}},window.data={PINS_LIMIT:5,TYPES_MAP:{PALACE:"Дворец",FLAT:"Квартира",HOUSE:"Дом",BUNGALO:"Бунгало"},PRICE_RANGE:{LOW:{MIN:0,MAX:1e4},MIDDLE:{MIN:1e4,MAX:5e4},HIGH:{MIN:5e4,MAX:1/0}},DRAG_LIMIT:{X:{MIN:-30,MAX:1230},Y:{MIN:130,MAX:680}},PIN_SICE:{WIDTH:65,HEIGHT:65},DEFAULT_MAIN_PIN_X:601,DEFAULT_MAIN_PIN_Y:404,TAIL_HEIGHT:16},(()=>{const e=window.util.monipulateElementDOM(".map"),t=window.util.monipulateElementDOM(".map__pins"),o=window.util.monipulateElementDOM("#pin"),n=window.util.monipulateElementDOM("#card"),r=o.content.querySelector(".map__pin"),a=n.content.querySelector(".map__card"),i=n.content.querySelector(".popup__photo"),d=window.util.monipulateElementDOM(".map__filters-container"),l=window.util.monipulateElementDOM(".map__pin--main"),u=e=>{if("object"==typeof e)switch(e.button){case 0:window.map.activate(),window.form.activate(),l.removeEventListener("mousedown",u)}},c=()=>{const e=document.querySelectorAll(".map__pin:not(.map__pin--main)");for(let t=0;t<e.length;t++)e[t].remove()},s=()=>{let e=document.querySelector(".map__card");e&&e.remove()},p=()=>{e.classList.add("map--faded"),c(),s(),l.style.top=window.data.DEFAULT_MAIN_PIN_Y-window.data.PIN_SICE.HEIGHT/2+"px",l.style.left=window.data.DEFAULT_MAIN_PIN_X-window.data.PIN_SICE.WIDTH/2+"px",l.addEventListener("mousedown",u)};p();const w=e=>{window.filter.activate(e)},m=e=>{window.util.renderErrorMessage(e)},f=t=>{let o=r.cloneNode(!0),n=o.querySelector("img");return n.src=t.author.avatar,n.alt=t.offer.title,o.style.left=t.location.x+"px",o.style.top=t.location.y+"px",o.addEventListener("click",(()=>{let o=e.querySelector(".map__card");o&&o.remove(),_(t),document.addEventListener("keydown",(t=>{window.util.onEscDown(t,e.querySelector(".map__card"))}))})),o};window.renderPinsMarkup=e=>{let o=document.createDocumentFragment();for(let t=0;t<e.length;t++)o.appendChild(f(e[t]));t.appendChild(o)};const _=e=>{let t=a.cloneNode(!0);return t.querySelector(".popup__title").textContent=e.offer.title,t.querySelector(".popup__text--address").textContent=e.offer.address,t.querySelector(".popup__text--price").textContent=e.offer.price+"₽/ночь","palace"===e.offer.type?t.querySelector(".popup__type").textContent=window.data.TYPES_MAP.PALACE:"flat"===e.offer.type?t.querySelector(".popup__type").textContent=window.data.TYPES_MAP.FLAT:"house"===e.offer.type?t.querySelector(".popup__type").textContent=window.data.TYPES_MAP.HOUSE:t.querySelector(".popup__type").textContent=window.data.TYPES_MAP.BUNGALO,t.querySelector(".popup__text--capacity").textContent=`${e.offer.rooms} комнаты для ${e.offer.guests} гостей`,t.querySelector(".popup__text--time").textContent=`Заезд после ${e.offer.checkin}, выезд до ${e.offer.checkout}`,t.querySelector(".popup__features").innerHTML="",t.querySelector(".popup__features").appendChild((e=>{let t=document.createDocumentFragment();for(let o=0;o<e.length;o++){let n=document.createElement("li");n.className="popup__feature popup__feature--"+e[o],t.appendChild(n)}return t})(e.offer.features)),t.querySelector(".popup__description").textContent=e.offer.description,t.querySelector(".popup__photos").removeChild(t.querySelector(".popup__photo")),t.querySelector(".popup__photos").appendChild((e=>{let t=document.createDocumentFragment();for(let o=0;o<e.length;o++){let n=i.cloneNode(!0);n.src=e[o],t.appendChild(n)}return t})(e.offer.photos)),t.querySelector(".map__card .popup__avatar").src=e.author.avatar,d.insertAdjacentElement("beforebegin",t),t.querySelector(".popup__close").addEventListener("click",(()=>{t.remove(),document.removeEventListener("click",window.util.onEscDown)})),t};window.map={getMainPinDefaultCoords:()=>({x:window.data.DEFAULT_MAIN_PIN_X,y:window.data.DEFAULT_MAIN_PIN_Y}),removePins:c,removeMapCard:s,activate:()=>{window.backend.load(w,m),e.classList.remove("map--faded")},deactivate:p,renderPinsMarkup:window.renderPinsMarkup}})(),(()=>{const e=window.util.monipulateElementDOM(".map__pin--main");e.addEventListener("mousedown",(t=>{t.preventDefault();let o={x:t.clientX,y:t.clientY};const n=t=>{t.preventDefault();let n=o.x-t.clientX,r=o.y-t.clientY;o={x:t.clientX,y:t.clientY};let a=e.offsetLeft-n,i=e.offsetTop-r;const d=window.data.DRAG_LIMIT.Y.MIN-e.offsetHeight,l=window.data.DRAG_LIMIT.Y.MAX-e.offsetHeight,u=window.data.DRAG_LIMIT.X.MIN,c=window.data.DRAG_LIMIT.X.MAX-e.offsetWidth;a>=u&&a<=c&&(e.style.left=a+"px"),i>=d&&i<=l&&(e.style.top=i+"px");let s={x:a+Math.ceil(window.data.PIN_SICE.WIDTH/2),y:i+window.data.PIN_SICE.HEIGHT+window.data.TAIL_HEIGHT};window.form.setAddress(s)},r=e=>{e.preventDefault(),document.removeEventListener("mousemove",n),document.removeEventListener("mouseup",r)};document.addEventListener("mousemove",n),document.addEventListener("mouseup",r)}))})(),(()=>{const e=window.util.monipulateElementDOM(".map__pin--main"),t=window.util.monipulateElementDOM(".ad-form"),o=t.querySelectorAll(".ad-form__element"),n=t.querySelector(".ad-form-header"),r=t.querySelector("#address"),a=window.util.monipulateElementDOM("#type"),i=window.util.monipulateElementDOM("#price"),d=window.util.monipulateElementDOM("#timein"),l=window.util.monipulateElementDOM("#timeout"),u=window.util.monipulateElementDOM("#room_number"),c=window.util.monipulateElementDOM("#capacity"),s=window.util.monipulateElementDOM(".ad-form__submit"),p=window.util.monipulateElementDOM("main"),w=window.util.monipulateElementDOM("#success").content.querySelector(".success"),m=window.util.monipulateElementDOM("#error"),f=m.content.querySelector(".error"),_=m.content.querySelector(".error__button"),E=window.util.monipulateElementDOM(".ad-form__reset"),v=()=>{r.value=`${e.offsetTop-e.offsetHeight/2}, ${e.offsetLeft-e.offsetWidth/2}`};v(),window.fillAddress=()=>{let t=e.offsetLeft+Math.floor(e.offsetWidth/2),o=e.offsetTop+e.offsetHeight;r.value=`${t} ${o}`},e.addEventListener("keydown",(e=>{e.key===window.util.KEY_NAME.ENTER&&(window.map.activate(),window.form.activate(),window.fillAddress())}));const y=()=>{t.reset();for(let e=0;e<o.length;e++)o[e].disabled=!0;n.disabled=!0,window.map.getMainPinDefaultCoords(),v(),t.classList.add("ad-form--disabled")};y(),a.addEventListener("change",(e=>{switch(e.target.value){case"bungalow":i.min=0,i.placeholder="0";break;case"flat":i.min=1e3,i.placeholder="1000";break;case"house":i.min=5e3,i.placeholder="5000";break;case"palace":i.min=1e4,i.placeholder="10000"}})),d.addEventListener("change",(e=>{l.value=e.target.value})),l.addEventListener("change",(e=>{d.value=e.target.value}));const M={1:[1],2:[1,2],3:[1,2,3],100:[0]};u.addEventListener("change",(()=>{(e=>{let t=c.querySelectorAll("option");for(let e=0;e<t.length;e++)t[e].disabled=!0;for(let t=0;t<M[e].length;t++)c.querySelector(`option[value="${M[e][t]}"]`).disabled=!1,c.value=M[e][t]})(u.value)})),u.addEventListener("change",(e=>{e.target.setCustomValidity("")})),c.addEventListener("change",(e=>{e.target.setCustomValidity("")})),s.addEventListener("click",(()=>{h()}));const h=()=>{-1===M[u.value].indexOf(+c.value)?c.setCustomValidity("Количество гостей не влезут в выбранную комнату"):c.setCustomValidity("")},L=()=>{p.appendChild(f),window.addEventListener("keydown",(e=>{window.util.onEscDown(e,f)&&f.remove()})),document.addEventListener("click",(()=>{f.remove()})),_.addEventListener("click",(()=>{f.remove()}))},I=()=>{p.appendChild(w),window.addEventListener("keydown",(e=>{window.util.onEscDown(e,w)&&w.remove()})),document.addEventListener("click",(()=>{w.remove()})),window.map.deactivate(),window.form.deactivate(),window.filter.deactivate()};t.addEventListener("submit",(e=>{e.preventDefault();let o=new FormData(t);window.backend.upload(I,L,o)})),E.addEventListener("click",(function(){window.map.deactivate(),window.form.deactivate(),window.filter.deactivate()})),window.form={setAddress:window.fillAddress,activate:()=>{t.classList.remove("ad-form--disabled");for(let e=0;e<o.length;e++)o[e].disabled=!1;n.disabled=!1,window.fillAddress()},deactivate:y}})(),(()=>{const e=window.util.monipulateElementDOM(".map__filters"),t=e.querySelectorAll("select, input"),o=e.querySelector("#housing-type"),n=e.querySelector("#housing-price"),r=e.querySelector("#housing-rooms"),a=e.querySelector("#housing-guests"),i=e.querySelector("#housing-features");let d=[],l=[];const u=(e,t,o)=>"any"===e.value||e.value===t[o].toString(),c=e=>u(o,e.offer,"type"),s=e=>{let t=window.data.PRICE_RANGE[n.value.toUpperCase()];return!t||e.offer.price>=t.MIN&&e.offer.price<=t.MAX},p=e=>u(r,e.offer,"rooms"),w=e=>u(a,e.offer,"guests"),m=function(e){let t=i.querySelectorAll("input:checked");return Array.from(t).every((t=>e.offer.features.includes(t.value)))},f=window.util.debounce((()=>{l=d.slice(0),l=l.filter(c).filter(s).filter(p).filter(w).filter(m),window.map.removePins(),window.map.removeMapCard(),window.map.renderPinsMarkup(l.slice(0,window.data.PINS_LIMIT))}));window.filter={activate:o=>(d=o.slice(0),t.forEach((e=>{e.disabled=!1})),f(),e.addEventListener("change",f),o.slice(0,window.dataPINS_LIMIT)),deactivate:()=>{t.forEach((e=>{e.disabled=!0})),t.forEach((e=>{e.value="any"})),i.querySelectorAll("input").forEach((e=>{e.checked=!1})),e.removeEventListener("change",f)}}})()})();